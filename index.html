<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OPS Plan 3&nbsp;mois (septembre à décembre)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-yIKBs6ywmUDbPsf3zHa72FYz8aXTv/jvKgV34KNTxM/Z7mOs6OGCZIiq5lDn8MULy7z6ozqHicw4P93apElnfw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* CSS custom properties allow the theme to be customized dynamically. */
    :root {
      /* Softer palette for improved readability and a more modern feel. */
      --bg-color: #1e2a38;            /* overall background is slightly lighter */
      --header-bg: #152c4b;           /* header background remains dark but contrasts well */
      --card-bg: #23395d;             /* card backgrounds slightly lighter for improved contrast */
      --accent-color: #0099ff;        /* brighter blue for accent elements */
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
      background-color: var(--bg-color);
      color: #fff;
    }
    header {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      background-color: var(--header-bg);
      border-bottom: 2px solid var(--accent-color);
    }
    header img.logo {
      height: 50px;
      width: auto;
    }
    header h1 {
      margin: 0;
      font-size: 36px; /* slightly larger title for better visibility */
      color: #ffffff;
    }
    .admin-link {
      text-align: right;
      padding: 0 20px 10px;
    }
    .admin-link a {
      color: var(--accent-color);
      text-decoration: none;
      font-size: 14px;
    }
    /*
      Card grid container. We rely on JavaScript to calculate the number of columns and rows,
      but reduce the minimum card width to allow more cards to fit on larger screens.  
    */
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--accent-color);
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      /* Cards fill their grid cell. A minimum height helps to balance the layout across
         different screen heights. */
      /* Reduce the minimum height of cards to free space for comments and avoid
         unnecessary vertical stretching. The card height will expand naturally
         based on its content. */
      min-height: 280px;
      height: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
    }
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--accent-color);
      text-align: center;
    }

    /* Action buttons (comment, export) */
    .action-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--accent-color);
      cursor: pointer;
      margin-left: 8px;
      font-size: 16px;
      padding: 4px 6px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }

    .action-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    /* Display for saved comment */
    .comment-display {
      margin-top: 8px;
      font-size: 12px;
      color: #cccccc;
      white-space: pre-wrap;
    }
    .chart-container {
      position: relative;
      /* Let the chart container expand to fill available vertical space
         within the card; the actual height will be controlled by the grid layout. */
      flex: 1 1 auto;
      /* Fix the height of each chart to prevent canvas overflow and card overlap.
         A smaller height leaves more breathing room for multiple rows of cards. */
      height: 180px;
    }
    /* Layout for dashboard: create a sidebar for navigation and filters, and a main content area */
    .layout {
      display: flex;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .sidebar {
      width: 240px;
      background-color: #0b3150;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }
    .sidebar .logo-container {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .sidebar .logo-container img {
      height: 40px;
      margin-right: 10px;
    }
    .sidebar .nav {
      display: flex;
      flex-direction: column;
      margin-bottom: 30px;
    }
    /* Navigation links with icons. Each link has a flex layout with gap for the icon.
       Use subtle background highlighting on hover and an active state. */
    .sidebar .nav a {
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
      padding: 10px 12px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .sidebar .nav a:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--accent-color);
    }
    .sidebar .nav a.active {
      background-color: rgba(255, 255, 255, 0.15);
      color: var(--accent-color);
      font-weight: bold;
    }
    .sidebar .filters {
      margin-top: auto;
    }
    .sidebar .filters h3 {
      margin: 0 0 10px;
      font-size: 16px;
      color: var(--accent-color);
    }
    .sidebar label {
      font-size: 12px;
      margin-top: 10px;
      display: block;
    }
    .sidebar select {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: none;
      margin-top: 4px;
      background-color: #1f3a55;
      color: #ffffff;
    }

    /* Filter button styling */
    .filter-btn {
      margin-top: 12px;
      padding: 8px 12px;
      width: 100%;
      background-color: var(--accent-color);
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }
    .filter-btn:hover {
      background-color: #0056b3;
    }
    .main-content {
      /* Make the main content fill the viewport height and prevent internal scrolling.
         The header and dashboard grid will be laid out within this space so that
         the entire dashboard fits on a single screen without requiring the user
         to scroll the page. */
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--bg-color);
      height: 100vh;
      overflow: hidden;
    }
    .main-header {
      padding: 20px;
      /* Use a grid to center the title and position the admin link on the right. */
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      background-color: var(--header-bg);
      border-bottom: 2px solid var(--accent-color);
    }
    .main-header h1 {
      margin: 0;
      font-size: 32px;
      color: #ffffff;
      text-align: center;
    }
    .main-header a {
      color: var(--accent-color);
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    .main-header a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    /* Container for the dashboard cards inside main-content */
    .dashboard-container {
      /* Allow the dashboard to scroll vertically if there are many cards. */
      flex: 1;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;

      /* Set up a responsive grid layout entirely via CSS.  The browser will
         automatically wrap cards to new rows based on available space.  The
         minimum card width matches the value used in JavaScript (260 px). */
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;

      /* Ensure rows are uniform in height: each row is at least the minimum
         card height and can grow if a card contains more content (such as a
         long comment).  This prevents cards on different rows from
         overlapping visually. */
      grid-auto-rows: minmax(280px, auto);

      /* Center the collection of cards within the container so that when a row
         contains fewer items (for example, two cards on a wide screen) they
         remain centered rather than aligned hard to the left. */
      justify-content: center;
      align-items: stretch;
    }

    /* Increase font sizes and card dimensions on very large screens (e.g. 85'' TV) */
    @media screen and (min-width: 1600px) {
      header h1 {
        font-size: 42px;
      }
      .card h2 {
        font-size: 24px;
      }
      /* For very large screens, we rely on JavaScript to compute an appropriate grid layout.
         Keep the chart container flexible; the script will adjust row heights. */
      .container {
        /* The number of columns will be dynamically calculated in renderDashboard(). */
      }
    }
</style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo-container">
        <!-- Use root logo.png; assets folder not available in GitHub pages -->
        <img src="logo.png" alt="Logo AEM">
        <span style="font-size:16px; font-weight:bold; color:#ffffff;">AEM</span>
      </div>
      <div class="nav">
        <!-- Link to the dashboard itself (index.html). The "active" class highlights the current page. -->
        <a href="index.html" class="active"><i class="fa fa-tachometer-alt"></i> Dashboard</a>
        <!-- Link to the objectives view that filters categories with status "plan" -->
        <a href="plan.html"><i class="fa fa-calendar-alt"></i> Objectifs</a>
        <!-- Link to the view displaying completed actions (status "fait"). -->
        <a href="fait.html"><i class="fa fa-check-circle"></i> Actions&nbsp;complétées</a>
      </div>
      <div class="filters">
        <h3>Filtres</h3>
        <label for="quarterSelect">Trimestre</label>
        <select id="quarterSelect">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
        <label for="monthSelect">Mois</label>
        <select id="monthSelect">
          <option value="Sept">Sept</option>
          <option value="Oct">Oct</option>
          <option value="Nov">Nov</option>
          <option value="Déc">Déc</option>
        </select>
        <!-- Apply filter button -->
        <button id="applyFilterBtn" class="filter-btn">Appliquer le filtre</button>
      </div>
    </aside>
    <main class="main-content">
      <div class="main-header">
        <h1>OPS Plan 3&nbsp;mois (septembre à décembre)</h1>
        <a href="admin.html"><i class="fa fa-edit"></i> Mode Admin</a>
      </div>
      <div class="dashboard-container" id="dashboardContainer">
        <!-- Cards will be injected here by JavaScript -->
      </div>
    </main>
  </div>
  <script>
    // Default data if none is stored in localStorage
    const defaultData = {
      categories: [
        {
          name: "Santé et Sécurité",
          type: "bar",
          labels: ["Sept", "Oct", "Nov", "Déc"],
          datasets: [
            {
              label: "Objectif",
              data: [80, 80, 80, 80],
              backgroundColor: "rgba(0, 204, 102, 0.5)",
              borderColor: "rgba(0, 204, 102, 1)",
              borderWidth: 1
            },
            {
              label: "Réel",
              data: [75, 70, 78, 85],
              backgroundColor: "rgba(255, 99, 132, 0.5)",
              borderColor: "rgba(255, 99, 132, 1)",
              borderWidth: 1
            }
          ]
        },
        {
          name: "Communication",
          type: "line",
          labels: ["Sept", "Oct", "Nov", "Déc"],
          datasets: [
            {
              label: "Objectif",
              data: [85, 85, 85, 85],
              borderColor: "rgba(0, 204, 102, 1)",
              backgroundColor: "rgba(0, 204, 102, 0.2)",
              tension: 0.3
            },
            {
              label: "Réel",
              data: [80, 82, 78, 84],
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              tension: 0.3
            }
          ]
        },
        {
          name: "Formation",
          type: "bar",
          labels: ["Sept", "Oct", "Nov", "Déc"],
          datasets: [
            {
              label: "Objectif",
              data: [70, 75, 75, 80],
              backgroundColor: "rgba(0, 204, 102, 0.5)",
              borderColor: "rgba(0, 204, 102, 1)",
              borderWidth: 1
            },
            {
              label: "Réel",
              data: [65, 68, 70, 77],
              backgroundColor: "rgba(255, 159, 64, 0.5)",
              borderColor: "rgba(255, 159, 64, 1)",
              borderWidth: 1
            }
          ]
        },
        {
          name: "Gestion de la traçabilité",
          type: "bar",
          labels: ["Sept", "Oct", "Nov", "Déc"],
          datasets: [
            {
              label: "Objectif",
              data: [90, 92, 94, 95],
              backgroundColor: "rgba(0, 204, 102, 0.5)",
              borderColor: "rgba(0, 204, 102, 1)",
              borderWidth: 1
            },
            {
              label: "Réel",
              data: [88, 90, 91, 93],
              backgroundColor: "rgba(153, 102, 255, 0.5)",
              borderColor: "rgba(153, 102, 255, 1)",
              borderWidth: 1
            }
          ]
        },
        {
          name: "Optimisation des opérations",
          type: "line",
          labels: ["Sept", "Oct", "Nov", "Déc"],
          datasets: [
            {
              label: "Objectif",
              data: [85, 85, 87, 88],
              borderColor: "rgba(0, 204, 102, 1)",
              backgroundColor: "rgba(0, 204, 102, 0.2)",
              tension: 0.3
            },
            {
              label: "Réel",
              data: [80, 82, 85, 83],
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              tension: 0.3
            }
          ]
        },
        {
          name: "Déclaration des N/C opérations et qualité",
          type: "bar",
          labels: ["Sept", "Oct", "Nov", "Déc"],
          datasets: [
            {
              label: "Objectif",
              data: [95, 95, 95, 95],
              backgroundColor: "rgba(0, 204, 102, 0.5)",
              borderColor: "rgba(0, 204, 102, 1)",
              borderWidth: 1
            },
            {
              label: "Réel",
              data: [90, 92, 94, 94],
              backgroundColor: "rgba(255, 205, 86, 0.5)",
              borderColor: "rgba(255, 205, 86, 1)",
              borderWidth: 1
            }
          ]
        }
      ]
    };
    
    // Load data from localStorage or fallback to default
    function loadDashboardData() {
      const stored = localStorage.getItem('dashboardData');
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          console.error('Erreur de parsing des données enregistrées', e);
        }
      }
      return defaultData;
    }

  // Helper to load a comment for a given category index
  function loadComment(index) {
    return localStorage.getItem('comment_' + index) || '';
  }
  // Save a comment for a given category index
  function saveComment(index, text) {
    localStorage.setItem('comment_' + index, text);
  }
  // Download a specific chart as an image
  function downloadChart(index) {
    const canvas = document.getElementById('chart-' + index);
    if (!canvas) return;
    const data = loadDashboardData();
    const name = data.categories[index] ? data.categories[index].name : 'chart';
    const link = document.createElement('a');
    link.download = name + '.png';
    link.href = canvas.toDataURL('image/png');
    // Trigger download
    link.click();
  }
    
    // Apply saved theme colours from localStorage and fallback to defaults
    function applyTheme() {
      try {
        const theme = JSON.parse(localStorage.getItem('theme'));
        if (theme) {
          Object.entries(theme).forEach(([key, value]) => {
            document.documentElement.style.setProperty(`--${key}`, value);
          });
        }
      } catch (e) {
        console.error('Erreur lors du chargement du thème', e);
      }
    }

    // Render cards and charts
    function renderDashboard() {
      const container = document.getElementById('dashboardContainer');
      container.innerHTML = '';
      // Compute dynamic grid layout so that all cards fit within the viewport height.
      // In the new layout, the header is contained within the main-content section
      const headerEl = document.querySelector('.main-header');
      const headerHeight = headerEl ? headerEl.offsetHeight : 0;
      // Use a responsive CSS grid layout. We let the browser automatically decide how
      // many cards to place per row using auto-fit. The minimum card width controls
      // how narrow cards can get before wrapping to the next row.
      const minCardWidth = 260;
      const gapSize = 20;
      const data = loadDashboardData();
      container.style.display = 'grid';
      container.style.gridTemplateColumns = `repeat(auto-fit, minmax(${minCardWidth}px, 1fr))`;
      container.style.gap = `${gapSize}px`;
      // Allow the container height to grow naturally. The surrounding layout handles
      // scrolling if needed.
      container.style.height = 'auto';
      // Now iterate over categories to create cards and charts
      data.categories.forEach((cat, index) => {
        // Create card container
        const card = document.createElement('div');
        card.className = 'card';
        // Title and optional link container
        const titleWrapper = document.createElement('div');
        titleWrapper.style.display = 'flex';
        titleWrapper.style.justifyContent = 'space-between';
        titleWrapper.style.alignItems = 'center';
        // Title
        const title = document.createElement('h2');
        title.textContent = cat.name;
        titleWrapper.appendChild(title);
        // If a URL is provided, add a link icon
        if (cat.url && cat.url.trim() !== '') {
          const link = document.createElement('a');
          link.href = cat.url;
          link.target = '_blank';
          link.title = 'Ouvrir le lien dans un nouvel onglet';
          link.style.color = 'var(--accent-color)';
          link.style.marginLeft = '10px';
          link.innerHTML = '<i class="fa fa-link"></i>';
          titleWrapper.appendChild(link);
        }
        // Threshold indicator
        if (typeof cat.threshold === 'number' && !isNaN(cat.threshold)) {
          const sumObj = cat.datasets[0].data.reduce((a, b) => a + b, 0);
          const sumReel = cat.datasets[1].data.reduce((a, b) => a + b, 0);
          const ratioPct = sumObj > 0 ? (sumReel / sumObj) * 100 : 0;
          const indicator = document.createElement('span');
          indicator.style.marginLeft = '10px';
          if (ratioPct >= cat.threshold) {
            indicator.innerHTML = '<i class="fa fa-arrow-up" style="color:#00cc66;"></i>';
          } else {
            indicator.innerHTML = '<i class="fa fa-arrow-down" style="color:#e74c3c;"></i>';
          }
          titleWrapper.appendChild(indicator);
        }
        // Export button
        const exportBtn = document.createElement('button');
        exportBtn.className = 'action-btn';
        exportBtn.title = 'Exporter le graphique';
        exportBtn.innerHTML = '<i class="fa fa-download"></i>';
        exportBtn.onclick = (e) => {
          e.stopPropagation();
          downloadChart(index);
        };
        titleWrapper.appendChild(exportBtn);
        // Comment button
        const commentBtn = document.createElement('button');
        commentBtn.className = 'action-btn';
        commentBtn.title = 'Ajouter ou modifier un commentaire';
        commentBtn.innerHTML = '<i class="fa fa-comment"></i>';
        commentBtn.onclick = (e) => {
          e.stopPropagation();
          const existing = loadComment(index);
          const newCom = prompt('Entrer un commentaire pour "' + cat.name + '" :', existing || '');
          if (newCom !== null) {
            saveComment(index, newCom.trim());
            renderDashboard();
          }
        };
        titleWrapper.appendChild(commentBtn);
        card.appendChild(titleWrapper);
        // Canvas for chart
        const canvas = document.createElement('canvas');
        canvas.id = 'chart-' + index;
        canvas.style.width = '100%';
        // Let the canvas fill its container; the height will be determined by flex/grid layout.
        canvas.style.height = '100%';
        const chartWrapper = document.createElement('div');
        chartWrapper.className = 'chart-container';
        chartWrapper.appendChild(canvas);
        card.appendChild(chartWrapper);
        // Display saved comment below the chart
        const commentText = loadComment(index);
        if (commentText) {
          const commentDiv = document.createElement('div');
          commentDiv.className = 'comment-display';
          // Create span for comment text
          const commentSpan = document.createElement('span');
          commentSpan.textContent = 'Commentaire : ' + commentText;
          commentDiv.appendChild(commentSpan);
          // Create delete button for comment
          const delBtn = document.createElement('button');
          delBtn.className = 'action-btn';
          delBtn.style.marginLeft = '8px';
          delBtn.title = 'Supprimer le commentaire';
          delBtn.innerHTML = '<i class="fa fa-trash"></i>';
          delBtn.onclick = (ev) => {
            ev.stopPropagation();
            if (confirm('Supprimer ce commentaire ?')) {
              saveComment(index, '');
              renderDashboard();
            }
          };
          commentDiv.appendChild(delBtn);
          card.appendChild(commentDiv);
        }
        container.appendChild(card);
        // Chart configuration depending on type
        const ctx = canvas.getContext('2d');
        // Determine options and data for each type
        let chartConfig;
        if (cat.type === 'gauge') {
          // Compute ratio (sum actual / sum objective * 100)
          const sumObjectif = cat.datasets[0].data.reduce((a, b) => a + b, 0);
          const sumReel = cat.datasets[1].data.reduce((a, b) => a + b, 0);
          const ratio = sumObjectif > 0 ? Math.min(Math.max((sumReel / sumObjectif) * 100, 0), 100) : 0;
          // Colors: actual colour and a muted remainder colour (use card background)
          const colourActual = cat.datasets[1].borderColor || cat.datasets[1].backgroundColor || 'rgba(0, 204, 102, 1)';
          let remainderColour = getComputedStyle(document.documentElement).getPropertyValue('--card-bg') || '#1f3a55';
          remainderColour = remainderColour.trim();
          chartConfig = {
            type: 'doughnut',
            data: {
              labels: ['Réel', 'Manquant'],
              datasets: [{
                data: [ratio, 100 - ratio],
                backgroundColor: [colourActual, remainderColour],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '70%',
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || '';
                      const value = context.parsed;
                      return `${label}: ${value.toFixed(1)}%`;
                    }
                  }
                },
                // Custom plugin to draw percentage in center
                centerText: {
                  // custom option to pass value
                  value: ratio
                }
              }
            },
            plugins: [{
              id: 'centerText',
              afterDraw(chart, args, opts) {
                // Draw the percentage value in the center of the gauge
                const { ctx, chartArea } = chart;
                const { left, top, right, bottom } = chartArea;
                const width = right - left;
                const height = bottom - top;
                ctx.save();
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = '#ffffff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const value = opts.value || 0;
                ctx.fillText(`${value.toFixed(1)}%`, left + width / 2, top + height / 2);
                ctx.restore();
              }
            }]
          };
        } else {
          // Normal charts: bar, line, pie, doughnut, radar
          chartConfig = {
            type: cat.type,
            data: {
              labels: cat.labels,
              datasets: cat.datasets
            },
            options: {
              responsive: true,
              // Disable aspect ratio to allow the chart to fill the height of its container
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  labels: { color: '#fff' }
                },
                title: {
                  display: false
                }
              }
            }
          };
          // If chart type requires scales, add them
          if (cat.type === 'bar' || cat.type === 'line' || cat.type === 'radar') {
            chartConfig.options.scales = {
              x: {
                ticks: { color: '#fff' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y: {
                ticks: { color: '#fff' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                beginAtZero: true
              }
            };
          }
        }
        const chartInstance = new Chart(ctx, chartConfig);
        // Force the chart to resize to its container after creation. This prevents
        // charts from overflowing their cards and helps maintain a consistent layout.
        if (typeof chartInstance.resize === 'function') {
          chartInstance.resize();
        }
      });
    }
    
    // When the document is ready, apply the theme then render the dashboard
    document.addEventListener('DOMContentLoaded', () => {
      applyTheme();
      renderDashboard();
      // Attach filter application
      const filterBtn = document.getElementById('applyFilterBtn');
      if (filterBtn) {
        filterBtn.addEventListener('click', () => {
          renderDashboard();
        });
      }
    });
  </script>
</body>
</html>